# 7.1 概述

<B> 1. 概念 </B>

在ROS中机器人导航(Navigation)由多个功能包组合实现，ROS中又称之为导航功能包集，关于导航模块，官方介绍如下：

```bash
一个二维导航堆栈，它接收来自里程计、传感器流和目标姿态的信息，并输出发送到移动底盘的安全速度命令。
```

更通俗的讲：导航其实就是机器人自主的从A点移动到B点的过程。

<div align="center">
    <img src="./image/01_导航官方简介.png" />
</div>

<B> 2. 作用 </B>

秉着“不重复发明轮子”的原则，ROS中导航相关的功能包集为机器人导航提供了一套通用的实现，开发者不再需要关注于导航算法、硬件交互...等偏复杂、偏底层的实现，这些实现都由更专业的研发人员管理、迭代和维护，开发者可以更专注于上层功能，而对于导航功能的调用，只需要根据自身机器人的相关参数合理设置各模块的配置文件即可，当然，如果有必要，也可以基于现有的功能包二次开发实现一些定制化需求，这样可以大大提高研发效率，缩短产品落地时间。总而言之，对于一般开发者而言，ROS的导航功能包集优势如下：

- 安全：由专业团队开发和维护
- 功能：功能更稳定且全面
- 高效：解放开发者，让开发者更专注于上层功能实现

---

## 7.1.1 导航模块简介

机器人是如何实现导航的呢？或换言之，机器人是如何从A点移动到B点的呢？ROS官方提供了一张导航功能包集的图示，该图中囊括了ROS导航的一些关键技术：

<div align="center">
    <img src="./image/02_导航官方架构.png" />
</div>

假定我们已经以特定方式配置机器人，导航功能包集将使其可以运动。上图概述了这种配置方式。白色的部分是必须且已实现的组件，灰色的部分是可选且已实现的组件，蓝色的部分是必须为每一个机器人平台创建的组件。

总结下来，涉及的关键技术有如下五点：

1. 全局地图
2. 自身定位
3. 路径规划
4. 运动控制
5. 环境感知

机器人导航实现与无人驾驶类似，关键技术也是由上述五点组成，只是无人驾驶是基于室外的，而我们当前介绍的机器人导航更多是基于室内的。

### 1. 全局地图

在现实生活中，当我们需要实现导航时，可能会首先参考一张全局性质的地图，然后根据地图来确定自身的位置、目的地位置，并且也会根据地图显示来规划一条大致的路线...对于机器人导航而言，也是如此，在机器人导航中地图是一个重要的组成元素，当然如果要使用地图，首先需要绘制地图。关于地图建模技术不断涌现，这其中有一门称之为SLAM的理论脱颖而出：

1. SLAM(simultaneous localization and mapping)，也称之为CML(Concurrent Mapping and Localization)，即同时定位与地图构建，或并发建图与定位。SLAM问题可以描述为：机器人在未知环境中从一个未知位置开始移动，在移动过程中根据位置估计和地图进行自身定位，同时在自身定位的基础上建造增量式地图，以绘制出外部环境的完全地图。

2. 在ROS中，较为常用的SLAM实现也比较多，比如：gmapping、hector_slam、cartographer、rgbdslam、ORB_SLAM...

3. 当然如果要完成SLAM，机器人必须要具备感知外界环境的能力，尤其是要具备获取周围环境深度信息的能力。感知的实现需要依赖于传感器，比如：激光雷达、摄像头、RGB-D摄像头...

4. SLAM可以用于地图生成，而生成的地图还需要被保存以待后续使用，在ROS中保存地图的功能包是map_server。

另外注意：SLAM虽然是机器人导航的重要技术之一，但是二者并不等价，确切地讲，SLAM只是实现地图构建和即时定位。

### 2. 自身定位

导航伊始和导航过程中，机器人都需要确定当前自身的位置，如果在室外，那么GPS是一个不错的选择，而如果室内、隧道、地下或一些特殊的屏蔽GPS信号的区域，由于GPS信号弱化甚至完全不可用，那么就必须另辟蹊径了，比如前面的SLAM就可以实现自身定位，除此之外，ROS中还提供了一个用于定位的功能包：amcl。

amcl(adaptive Monte Carlo Localization)自适应的蒙特卡洛定位，是用于2D移动机器人的概率定位系统。它实现了自适应(或KLD采样)蒙特卡洛定位方法，该方法使用例子过滤器根据已知地图跟踪机器人的姿态。

### 3. 路径规划

导航就是机器人从A点运动到B点的过程，在这一过程中，机器人需要根据目标位置计算全局运动路线，并且在运动过程中，还需要实时根据出现的一些动态障碍物调整运动路径，直至到达目标点，该过程就称之为路径规划。在ROS中提供了move_base包来实现路径规划，该功能包主要由两大规划期组成：

1. 全局路径规划器(global planner)

   根据给定的目标点和全局地图实现总体的路径规划，使用Dijkstra或A*算法进行全局路径规划，计算最优路线，作为全局路线。

2. 本地实时规划(local planner)

   在实际导航过程中，机器人可能无法按照给定的全局最优路线运行，比如：机器人在运行中，可能会随时出现一定的障碍物...本地规划的作用就是使用一定算法(Dynamic Window Approaches)来实现障碍物的规避，并选取当前最优路径以尽量符合全局最优路径

全局路径规划与本地路径规划是相对的，全局路径规划侧重于全局、宏观实现，而本地路径规划侧重于当前、微观实现。

### 4. 运动控制

导航功能包集假定它可以通过话题"cmd_vel"发布`geometry_msgs/Twist`类型的消息，这个消息基于机器人的基座坐标系，它传递的是运动命令。这意味着必须有一个节点订阅"cmd_vel"话题，将该话题上的速度命令转换为电机命令并发送。

### 5. 环境感知

感知周围环境感知，比如：摄像头、激光雷达、编码器...，摄像头、激光雷达可以用于感知外界环境的深度信息，编码器可以感知电机的转速信息，进而可以获取速度信息并生成里程计信息。

在导航功能包集中，环境感知也是一重要模块实现，它为其他模块提供了支持。其他模块诸如：SLAM、amcl、move_base都需要依赖于环境感知。

---


## 7.1.2 导航之坐标系

### 1. 简介

定位是导航中的重要实现之一，所谓定位，就是参考某个坐标系(比如：以机器人的出发点为原点创建坐标系)在该坐标系中标注机器人。定位原理看似简单，但是这个坐标系不是客观存在的，我们也无法以上帝视角确定机器人的位姿，定位实现需要依赖于机器人自身，机器人需要逆向推导参考系原点并计算坐标系相对关系，该过程实现常用方式有两种：

- 通过里程计定位：实时收集机器人的速度信息计算并发布机器人坐标系与父级参考系的相对关系。
- 通过传感器定位：通过传感器收集外界环境信息通过匹配计算并发布机器人坐标系与父级参考系的相对关系。

两种方式在导航中都会经常使用。

### 2. 特点

两种定位方式都有各自的优缺点。

里程计定位：

- 优点：里程计定位信息是连续的，没有离散的跳跃。
- 缺点：里程计存在累计误差，不利于长距离或长期定位。

传感器定位：

- 优点：比里程计定位更精确；
- 缺点：传感器定位会出现跳变的情况，且传感器定位在标志物较少的环境下，其定位精度会大打折扣。

两种定位方式优缺点互补，应用时一般二者结合使用。

### 3. 坐标系变换

上述两种定位实现中，机器人坐标系一般使用机器人模型中的根坐标系(base_link或base_footprint)，里程计定位时，父级坐标系一般称之为odom，如果通过传感器定位，父级参考系一般称之为map。当二者结合使用时，map和odom都是机器人模型根坐标系的父级，这是不符合坐标变换中"单继承"的原则的，所以，一般会将转换关系设置为：map->odom->base_link或base_footprint。

---

## 7.1.3 导航条件说明

导航实现，在硬件和软件方面是有一定要求的，需要提前准备。

### 1. 硬件要求

虽然导航功能包集被设计成尽可能的通用，在使用时仍然有三个主要的硬件限制：

1. 它是为差速驱动的轮式机器人涉及的。它假设底盘受到理想的运动命令的控制并可实现预期的结果，命令的格式为：x速度分量，y速度分量，角速度(theta)分量。
2. 它需要在底盘上安装一个单线激光雷达。这个激光雷达用于构建地图和定位。
3. 导航功能包集是正方形的机器人开发的，所以方形或圆形的机器人将是性能最好的。它也可以工作在任意形状和大小的机器人上，但是较大的机器人将很难通过狭窄的空间。

### 2. 软件

导航功能实现之前，需要搭建一些软件环境：

1. 毋庸置疑的，必须先要安装ROS
2. 当前导航基于仿真环境，先保证上一章的机器人系统仿真可以正常执行

    在仿真环境下，机器人可以正常接收`/cmd_vel`消息，并发布里程计消息，传感器消息发布也正常，也即导航模块中的运动控制和环境感知实现完毕。

后续导航实现中，我们主要关注于：使用SLAM绘制地图、地图服务、自身定位与路径规划。

---