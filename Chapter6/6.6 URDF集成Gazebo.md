# 6.6 URDF集成Gazebo

URDF需要集成进Rviz或Gazebo才能显示可视化的机器人模型，前面已经介绍了URDF与Rviz的集成，本节主要介绍：

- URDF与Gazebo的基本集成流程；
- 如果要在Gazebo中显示机器人模型，URDF需要做的一些额外配置；
- 关于Gazebo仿真环境的搭建。

---

## 6.6.1 URDF与Gazebo基本集成流程

URDF与Gazebo集成流程与Rviz实现类似，主要步骤如下：

1. 创建功能包，导入依赖项
2. 编写URDF或Xacro文件
3. 启动Gazebo并显示机器人模型

### 1. 创建功能包

创建新功能包，导入依赖包：urdf、xacro、gazebo_ros、gazebo_ros_control、gazebo_plugins

### 2. 编写URDF文件

```xml
<robot name="mycar">
    <link name="base_link">
        <!-- 可视化部分 -->
        <visual>
            <geometry>
                <box size="0.5 0.3 0.1" />
            </geometry>
            <origin xyz="0 0 0" rpy="0 0 0" />
            <material name="yellow">
                <color rgba="0.5 0.3 0 0.5" />
            </material>
        </visual>
        <!-- 1.设置碰撞参数 -->
        <!-- 如果是标准几何体。直接复制 visual 的 geometry 和 origin 即可 -->
        <collision>
            <geometry>
                <box size="0.5 0.3 0.1" />
            </geometry>
            <origin xyz="0 0 0" rpy="0 0 0" />
        </collision>
        <!-- 2.设置惯性矩阵 -->
        <inertial>
            <!-- 重心的偏移 -->
            <origin xyz="0 0 0" />
            <!-- 惯性，和质量有关 -->
            <mass value="2" />
            <inertial ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
        </inertial>
    </link>

    <!-- gazebo 有自己的颜色设置标签 -->
    <gazebo reference="base_link">
        <material>gazebo/Red</material>
    </gazebo>
</robot>
```

注意，当URDF需要与Gazebo集成时，和Rviz有明显区别：

1. 必须使用collision标签，因为既然是仿真环境，那么必然涉及到碰撞检测，collision提供碰撞检测的依据。
2. 必须使用inertial标签，此标签标注了当前机器人某个刚体部分的惯性矩阵，用于一些力学相关的仿真计算。
3. 颜色设置，也需要重新使用gazebo标签标注，因为之前的颜色设置为了方便调试包含透明度，仿真环境下没有此选项。

### 3. 启动Gazebo并显示模型

launch文件实现：

```xml
<launch>
    <!-- 1.需要在参数服务器中载入 urdf -->
    <param name="robot_description" textfile="$(find urdf02_gazebo)/urdf/demo01_helloworld.urdf" />
    <!-- 2.启动Gazebo仿真环境 -->
    <include file="$(find gazebo_ros)/launch/empty_world.launch" />
    <!-- 3.在Gazebo中添加机器人模型 -->
    <node pkg="gazebo_ros" type="spawn_model" name="urdf_spawner" args="-urdf -model mycar -param robot_description" />
</launch>
```

代码解释：

```xml
<include file="$(find gazebo_ros)/launch/empty_world.launch" />
<!-- 启动 Gazebo 的仿真环境，当前环境为空环境 -->
```

```xml
<node pkg="gazebo_ros" type="spawn_model" name="urdf_spawner" args="-urdf -model mycar -param robot_description" />
<!-- 
    在 Gazebo 中加载一个机器人模型，该功能由 gazebo_ros 下的 spawn_model 提供：
    -urdf 加载的是urdf文件
    -model mycar 模型名称是 mycar
    -param robot_description 从参数 robot_description 中载入模型
    -x 模型载入的x坐标
    -y 模型载入的y坐标
    -z 模型载入的z坐标
 -->
```

---


## 6.6.2 URDF集成Gazebo相关设置

较之于rviz，gazebo在集成URDF时，需要做些许修改，比如：必须添加collision碰撞属性相关参数、必须添加inertial惯性矩阵相关参数，另外，如果直接移植Rviz中机器人的颜色设置是没有显示的，颜色设置也必须做相应的变更。

### 1. collision

如果机器人link是标准的几何体形状，和link的visual属性设置一致即可。

### 2. inertial

惯性矩阵的设置需要结合link的质量与外形参数动态生成，标准的球体、圆柱与立方体的惯性矩阵公式如下(已经封装为xacro实现)：

球体惯性矩阵:

```xml
<!-- Macro for inertial matrix -->
<xacro:macro name="sphere_inertial_matrix" params="m r">
    <inertial>
        <mass value="${m}" />
        <inertia ixx="${2*m*r*r/5}" ixy="0" ixz="0" 
            iyy="${2*m*r*r/5}" iyz="0" 
            izz="${2*m*r*r/5}" />
    </inertial>
</xacro:macro>
```

圆柱惯性矩阵：

```xml
<xacro:macro name="cylinder_inertial_matrix" params="m r">
    <inertial>
        <mass value="${m}" />
        <inertia ixx="${m*(3*r*r + h*h)/12}" ixy="0" ixz="0"
            iyy="${m*(3*r*r + h*h)/12}" iyz="0" 
            izz="${m*r*r/2}" />
    </inertial>
</xacro:macro>
```

立方体惯性矩阵：

```xml
<xacro:macro name="Box_inertial_matrix" params="m l w h">
    <inertial>
        <mass value="${m}" />
        <inertia ixx="${m*(h*h + l*l)/12}" ixy="0" ixz="0" 
            iyy="${m*(w*w + l*l)/12}" iyz="0" 
            izz="${m*(w*w + h*h)/12}" />
    </inertial>
</xacro:macro>
```

需要注意的是，原则上，除了base_footprint外，机器人的每个刚体部分都需要设置惯性矩阵，且惯性矩阵必须经计算得出，如果随意定义刚体部分的惯性矩阵，那么可能会导致机器人在Gazebo中出现抖动，移动等现象。

### 3. 颜色设置

在 gazebo 中显示link的颜色，必须要使用指定的标签：

```xml
<gazebo reference="link节点名称">
    <material>Gazebo/Blue</material>
</gazebo>
```

<B>PS:</B>material标签中，设置的值区分大小写，颜色可以设置为Red Blue Green Black...

---

## 6.6.3 URDF集成Gazebo实操

<B>需求描述：</B>

将之前的机器人模型(xacro)显示在gazebo中

<B>结果演示：</B>

<div align="center">
    <img src="./image/18_gazebo案例.png" />
</div>

<B>实现流程：</B>

1. 需要编写封装惯性矩阵算法的xacro文件
2. 为机器人模型中的每一个link添加collision和inertial标签，并且重置颜色属性
3. 在launch文件中启动gazebo并添加机器人模型

### 1. 编写封装惯性矩阵算法的xacro文件

```xml

```

### 2. 复制相关的xacro文件，并设置collision inertial 以及 color 等参数

#### A. 底盘Xacro文件

#### B. 摄像头Xacro文件

#### C. 激光雷达Xacro文件

### 3. 在gazebo中执行

launch文件：

```xml

```