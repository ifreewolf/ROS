# 5.1 TF坐标变换

机器人系统上，有多个传感器，如激光雷达、摄像头等，有的传感器是可以感知机器人周边的物体方位(或者称之为:坐标，横向、纵向、高度的距离信息)的，以协助机器人定位障碍物，可以直接将物体相对该传感器的方位信息，等价于物体相对于机器人系统或机器人其它组件的方位信息吗？显然是不行的，这中间需要一个转换过程。更具体描述如下:

>场景1:雷达与小车
>
>现有一移动式机器人底盘，在底盘上安装了一雷达，雷达相对于底盘的偏移量已知，现雷达检测到一障碍物信息，获取到坐标分别为(x,y,z)，该坐标是以雷达为参考系的，如何将这个坐标转换成以小车为参考系的坐标呢？

<div align="center">
    <img src="./image/10TF01.png" />
    <img src="./image/11TF02.png" />
</div>

>场景2:现有一带机械臂的机器人(比如:PR2)需要夹取目标物，当前机器人头部摄像头可以探测到目标物的坐标(x,y,z)，不过该坐标是以摄像头为参考系的，而实际操作目标物的是机械臂的夹具，当前我们需要将该坐标转换成相对于机械臂夹具的坐标，这个过程如何实现？

<div align="center">
    <img src="./image/PR2坐标变换.png" />
</div>

当然，根据我们高中学习的知识，在明确了不同坐标系之间的的相对关系，就可以实现任何坐标点在不同坐标系之间的转换，但是该计算实现是较为常用的，且算法也有点复杂，因此在 ROS 中直接封装了相关的模块: 坐标变换(TF)。

---

<B>概念</B>

<B>TF:</B>TransForm Frame， 坐标变换

<B>坐标系：</B>ROS中是通过坐标系来标定物体的，确切的是通过右手坐标系来标定的。

<div align="center">
    <img src="./image/右手坐标系.jpg" />
</div>

<B>作用</B>

在ROS中用于实现不同坐标系之间的点或向量的转换。

<B>案例</B>

<B>小乌龟跟随案例：</B>如本章引言部分演示。

<B>说明</B>

在ROS中坐标变换最初对应的是tf，不过在hydro版本开始，tf被弃用，迁移到tf2，后者更为简洁高效，tf2对应得常用功能包有：

tf2_geometry_msgs:可以将ROS消息转换成tf2消息。

tf2：封装了坐标变换的常用消息。

tf2_ros:为tf2提供了roscpp和rospy绑定，封装了坐标变换常用的API。

---



## 5.1.1 坐标msg消息

订阅发布模型中数据载体msg是一个重要实现，首先需要了解一下，在坐标转换实现中常用的msg:`geometry_msgs/TransformStamped`和`geometry_msgs/PointStamped`

前者用于传输坐标系相关位置信息，后者用于传输某个坐标系内坐标点的信息。在坐标变换中，频繁的需要使用到坐标系的相对关系以及坐标点信息。

### 1. geometry_msgs/TransformStamped

命令行键入：`rosmsg info geometry_msgs/TransformStamped`

```bash
std_msgs/Header header              # 头信息
  uint32 seq                            # |-- 序列号
  time stamp                            # |-- 时间戳
  string frame_id                       # |-- 坐标ID
string child_frame_id               # 子坐标系的id
geometry_msgs/Transform transform   # 坐标信息
  geometry_msgs/Vector3 translation     # |-- 偏移量
    float64 x                               # |-- X 方向的偏移量
    float64 y                               # |-- Y 方向的偏移量
    float64 z                               # |-- Z 方向的偏移量
  geometry_msgs/Quaternion rotation     # |-- 四元数
    float64 x
    float64 y
    float64 z
    float64 w
```

四元数用于表示坐标的相对姿态。


### 2. geometry_msgs/PointStamped

命令行键入：`rosmsg info geometry_msgs/PointStamped`

```bash
std_msgs/Header header      # 头
  uint32 seq                    # |-- 序号
  time stamp                    # |-- 时间戳
  string frame_id               # |-- 所属坐标系的id
geometry_msgs/Point point   # 点坐标
  float64 x                     # |-- x y z 坐标
  float64 y
  float64 z
```

---


## 5.1.2 静态坐标变换

所谓静态坐标变换，是指两个坐标系之间的相对位置是固定的。

<B>需求描述：</B>

现有一机器人模型，核心构成包含主体与雷达，各对应一坐标系，坐标系的原点分别位于主体与雷达的物理中心，已知雷达原点相对于主体原点位移关系如下：x 0.2 y 0.0 z 0.5。当前雷达检测到一障碍物，在雷达坐标系中障碍物的坐标为(2.0 3.0 5.0)，请问，该障碍物相对于主体的坐标是多少？

<B>结果演示：</B>

<div align="center">
    <img src="./image/静态坐标变换_坐标系关系.png">
</div>


<B>实现分析：</B>

1. 坐标系相对关系，可以通过发布方发布
2. 订阅方，订阅到发布的坐标系相对关系，再传入坐标点信息(可以写死)，然后借助于tf实现坐标变换，并将结果输出。


<B>实现流程：</B>C++与Python实现流程一致

1. 新建功能包，添加依赖
2. 编写发布方实现
3. 编写订阅方实现
4. 执行并查看结果

---

方案A：C++实现

### 1. 创建功能包

创建项目功能包依赖于tf2、tf2_ros、tf2_geometry_msgs、roscpp、rospy、std_msgs、geometry_msgs

### 2. 发布方

### 3. 订阅方

### 4. 执行

---

方案B：Python实现

