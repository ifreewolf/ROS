# 第三章 ROS通信机制进阶

上一章内容，主要介绍了ROS通信的实现，内容偏向于粗粒度的通信框架的讲解，没有详细介绍涉及的API，也没有封装代码，鉴于此，本章主要内容如下:

- ROS常用API介绍；
- ROS中自定义头文件与源文件的使用。

预期达成的学习目标:

- 熟练掌握ROS常用API；
- 掌握ROS中自定义头文件与源文件的配置。

## 3.1 常用API

- ROS节点的初始化相关API;
- NodeHandle的基本使用相关API;
- 话题的发布方，订阅方对象相关API;
- 服务的服务端，客户端对象相关API;
- 时间相关API;
- 日志输出相关API。

### 3.1.1 初始化

<B>C++</B>

```cpp
#include "ros/ros.h"

/**
 * 作用：ROS初始化函数
 * 
 * 参数：
 *  1. argc     ---- 参数个数（n+1）
 *  2. argv     ---- 封装参数的数组
 *  3. name     ---- 为节点命名(唯一性)
 *  4. options
 * 
 * 使用：
 *  1. argc 与 argv 的使用
 *      如果按照ROS中的特定格式传入实参，那么ROS可以加以使用，比如用来设置全局参数、给节点重命名...
 *  2. options 的使用
 *      节点名称需要保证唯一，会导致一个问题：同一个节点不能重复启动。
 *      结果：ROS 中当有重名的节点启动时，之前的节点会被关闭。
 *      需求：特定场景下，需要一个节点多次启动且能正常运行，怎么办？
 *      解决：设置启动项 ros::init_options::AnonymousName
 *          当创建ROS节点时，会在用户自定义的节点名称后缀随机数，从而避免重名问题。
 *      
 * 
 * 函数原型：
 * void init(int &argc, char **argv, const std::string& name, uint32_t options = 0);
*/

int main(int argc, char *argv[])
{

    ros::init(argc, argv, "init_api", ros::init_options::AnonymousName);
    ros::NodeHandle nh;

    int count = 0;
    ros::Rate rate(1);
    while (ros::ok())
    {
        ROS_INFO("%s node is running ---- %d", ros::this_node::getName().c_str(), count);
        count++;
        rate.sleep();
    }    
    
    return 0;
}
```

>argc和argv如果按照ROS中的特定格式传入实参，那么ROS可以加以使用，比如用来设置全局参数、给节点重命名。

使用`rosrun plumbing_api init_api _length:=2` 可以给这个node创建一个全局变量：length

```shell
fgs@fgs-MS-7D17:~/Workstations/ROS/Chapter3/demo04_ws$ rosrun plumbing_api demo01_init_api _length:=2
fgs@fgs-MS-7D17:~/Workstations/ROS/Chapter3/demo04_ws$ rosparam list
/init_api/length        # 这个就是初始化启动添加的全局变量，其中/init_api是node的命名。
/rosdistro
/roslaunch/uris/host_fgs_ms_7d17__38261
/rosversion
/run_id

fgs@fgs-MS-7D17:~/Workstations/ROS/Chapter3/demo04_ws$ rosparam get /init_api/length    # 可以获取
2
```

>节点名称需要保证唯一，会导致一个问题：同一个节点不能重复启动。ROS中当有重名的节点启动时，之前的节点会被关闭。
参数options可以解决这个问题，将options设置为`ros::init_options::AnonymousNmae`即可在每个启动的节点名称后面加上时间后缀，可以让一个节点重复启动。

未添加options前：

```shell
[ INFO] [1690990277.051701363]: /init_api node is running ---- 6
[ WARN] [1690990277.274786557]: Shutdown request received.
[ WARN] [1690990277.274874254]: Reason given for shutdown: [[/init_api] Reason: new node registered with same name]
```

给options添加设置后，同一个节点可以被多次启动。

```shell
fgs@fgs-MS-7D17:~/Workstations/ROS/Chapter3/demo04_ws$ rosnode list
/init_api_1690990405013105385 # 节点1，后跟时间戳
/init_api_1690990409531076982 # 节点2，后跟时间戳
/rosout
```



<B>Python</B>

```python
def init_node(name, argv=None, anonymous=False, log_level=None, disable_rostime=False, disable_rosout=False, disable_signals=False, xmlrpc_port=0, tcpros_port=0):
    """
    在ROS msater中注册节点

    @param name: 节点名称，必须保证节点名称唯一，节点名称中不能使用命名空间(不能包含 '/')
    @type  name: str

    @param anonymous: 取值为 true 时，为节点名称后缀随机编号
    @type anonymous: bool
    """
```